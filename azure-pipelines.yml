# Azure DevOps Pipeline - GitHub App Demo
# This pipeline demonstrates using GitHub App authentication to generate release notes

trigger:
  tags:
    include:
      - v*

# Allow manual trigger with parameters
parameters:
  - name: tagName
    displayName: 'Tag Name'
    type: string
    default: 'v1.0.0'
  - name: previousTag
    displayName: 'Previous Tag (optional)'
    type: string
    default: ''

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: nodeVersion
    value: '20.x'
  # These should be configured as pipeline variables (secret):
  # - APP_ID: Your GitHub App ID
  # - APP_PRIVATE_KEY: Your GitHub App private key (base64 encoded)
  # - INSTALLATION_ID: Your GitHub App installation ID

stages:
  - stage: GenerateReleaseNotes
    displayName: 'Generate Release Notes'
    jobs:
      - job: ReleaseNotesJob
        displayName: 'Generate and Publish Release Notes'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '$(nodeVersion)'

          - checkout: self
            persistCredentials: false
            displayName: 'Checkout Repository'

          - script: |
              npm install
            displayName: 'Install Dependencies'

          - script: |
              # Extract repository owner and name from the source repository
              REPO_URI="$(Build.Repository.Uri)"
              
              # Handle both HTTPS and SSH URLs
              if [[ "$REPO_URI" == *"github.com"* ]]; then
                REPO_OWNER=$(echo "$REPO_URI" | sed -n 's/.*github\.com[:/]\([^/]*\)\/.*/\1/p')
                REPO_NAME=$(echo "$REPO_URI" | sed -n 's/.*github\.com[:/][^/]*\/\(.*\)\.git/\1/p')
                
                # Remove .git suffix if present
                REPO_NAME=${REPO_NAME%.git}
                
                echo "Repository Owner: $REPO_OWNER"
                echo "Repository Name: $REPO_NAME"
                
                # Set as pipeline variables
                echo "##vso[task.setvariable variable=GITHUB_OWNER]$REPO_OWNER"
                echo "##vso[task.setvariable variable=GITHUB_REPO]$REPO_NAME"
              else
                echo "##vso[task.logissue type=error]Unable to extract GitHub repository information from: $REPO_URI"
                exit 1
              fi
            displayName: 'Extract Repository Information'

          - script: |
              # Determine the tag name
              if [ -n "$(Build.SourceBranch)" ] && [[ "$(Build.SourceBranch)" == refs/tags/* ]]; then
                TAG_NAME=${Build.SourceBranch#refs/tags/}
                echo "Tag from trigger: $TAG_NAME"
              else
                TAG_NAME="${{ parameters.tagName }}"
                echo "Tag from parameter: $TAG_NAME"
              fi
              
              echo "##vso[task.setvariable variable=TAG_NAME]$TAG_NAME"
              echo "Using tag: $TAG_NAME"
            displayName: 'Determine Tag Name'

          - script: |
              export GITHUB_OWNER=$(GITHUB_OWNER)
              export GITHUB_REPO=$(GITHUB_REPO)
              export TAG_NAME=$(TAG_NAME)
              export PREVIOUS_TAG="${{ parameters.previousTag }}"
              export APP_ID=$(APP_ID)
              export INSTALLATION_ID=$(INSTALLATION_ID)
              export APP_PRIVATE_KEY=$(APP_PRIVATE_KEY)
              
              echo "üöÄ Generating release notes for $TAG_NAME"
              echo "üì¶ Repository: $GITHUB_OWNER/$GITHUB_REPO"
              
              node generate-release-notes.js
            displayName: 'Generate Release Notes'
            env:
              APP_ID: $(APP_ID)
              APP_PRIVATE_KEY: $(APP_PRIVATE_KEY)
              INSTALLATION_ID: $(INSTALLATION_ID)

          - script: |
              echo "‚úÖ Release notes generation complete!"
              echo "üîó Check your GitHub repository for the new release"
              echo "üìç https://github.com/$(GITHUB_OWNER)/$(GITHUB_REPO)/releases"
            displayName: 'Summary'
