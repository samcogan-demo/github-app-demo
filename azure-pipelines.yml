trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: nodeVersion
    value: '20.x'

steps:
  - task: NodeTool@0
    displayName: 'Install Node.js'
    inputs:
      versionSpec: '$(nodeVersion)'

  - checkout: self
    persistCredentials: false

  - script: |
      npm install @octokit/auth-app
    displayName: 'Install Dependencies'

  - script: |
      node << 'SCRIPT'
      const { createAppAuth } = require('@octokit/auth-app');
      
      (async () => {
        try {
          // Decode base64 private key if needed, or use as-is
          let privateKey = process.env.APP_PRIVATE_KEY;
          
          // Check if the key is base64 encoded (doesn't start with -----)
          if (!privateKey.startsWith('-----')) {
            privateKey = Buffer.from(privateKey, 'base64').toString('utf-8');
          }
          
          const auth = createAppAuth({
            appId: process.env.APP_ID,
            privateKey: privateKey,
          });
          
          const { token } = await auth({
            type: 'installation',
            installationId: process.env.INSTALLATION_ID,
          });
          
          console.log('##vso[task.setvariable variable=GITHUB_TOKEN;issecret=true]' + token);
        } catch (error) {
          console.error('Error generating token:', error.message);
          process.exit(1);
        }
      })();
      SCRIPT
    displayName: 'Generate GitHub App Token'
    env:
      APP_ID: $(APP_ID)
      APP_PRIVATE_KEY: $(APP_PRIVATE_KEY)
      INSTALLATION_ID: $(INSTALLATION_ID)

  - script: |
      REPO_OWNER=$(echo "$(Build.Repository.Uri)" | sed -n 's/.*github\.com[:/]\([^/]*\)\/.*/\1/p')
      REPO_NAME=$(echo "$(Build.Repository.Name)" | sed 's/.*\///')
      
      echo "//npm.pkg.github.com/:_authToken=$(GITHUB_TOKEN)" > .npmrc
      echo "@${REPO_OWNER}:registry=https://npm.pkg.github.com/" >> .npmrc
      
      echo "Repository Owner: $REPO_OWNER"
      echo "Repository Name: $REPO_NAME"
    displayName: 'Configure npm for GitHub Packages'
    env:
      GITHUB_TOKEN: $(GITHUB_TOKEN)

  - script: |
      REPO_OWNER=$(echo "$(Build.Repository.Uri)" | sed -n 's/.*github\.com[:/]\([^/]*\)\/.*/\1/p')
      REPO_NAME=$(echo "$(Build.Repository.Name)" | sed 's/.*\///')
      
      node -e "
      const fs = require('fs');
      const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
      pkg.name = '@${process.env.REPO_OWNER}/${process.env.REPO_NAME}';
      pkg.repository.url = '$(Build.Repository.Uri)';
      fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
      console.log('Updated package.json with name: ' + pkg.name);
      "
    displayName: 'Update package.json'
    env:
      REPO_OWNER: $(echo "$(Build.Repository.Uri)" | sed -n 's/.*github\.com[:/]\([^/]*\)\/.*/\1/p')
      REPO_NAME: $(echo "$(Build.Repository.Name)" | sed 's/.*\///')

  - script: npm publish
    displayName: 'Publish to GitHub Packages'
    env:
      NODE_AUTH_TOKEN: $(GITHUB_TOKEN)

  - script: |
      REPO_OWNER=$(echo "$(Build.Repository.Uri)" | sed -n 's/.*github\.com[:/]\([^/]*\)\/.*/\1/p')
      REPO_NAME=$(echo "$(Build.Repository.Name)" | sed 's/.*\///')
      
      echo "‚úÖ Package published successfully!"
      echo "üì¶ Package: @${REPO_OWNER}/${REPO_NAME}"
      echo "üîê Authenticated using GitHub App"
      echo "üìç Registry: https://npm.pkg.github.com"
    displayName: 'Verify Publication'
